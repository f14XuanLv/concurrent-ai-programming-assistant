# 并发 AI 编程助手

## 背景

大型语言模型（LLM），如 Gemini 和 Claude，越来越多地被用于协助开发人员修改代码。然而，一个常见的瓶颈是这些模型通常按顺序处理对单个文件或一组文件的修改请求。即使单个提示请求更改多个文件，开发人员也常常需要等待 AI 完成所有修改后才能看到结果。这可能导致大量的等待时间和效率降低。

**并发 AI 编程助手**是一个基于 Web 的 IDE，旨在应对这一挑战。它采用两级 AI 策略：

1.  **一级 AI（全局分析 - 手动步骤）：** 用户使用一个强大的人工智能（例如 Claude-4-opus 或功能强大的 Gemini 模型）对代码库进行全局分析。用户向 AI 提供项目结构、相关文件内容及其高级需求。AI 的作用是识别跨多个文件所有必要的修改，并以特定的结构化格式输出这些指令，包括建议的并发操作数。
2.  **二级 AI（文件特定执行 - 由本应用自动执行）：** 用户将一级 AI 的结构化输出粘贴到此应用程序中。然后，应用程序解析这些指令，并对指定的 Gemini 模型（默认为 `gemini-2.5-flash-preview-05-20`，用户可配置）进行并发 API 调用，以并行执行每个文件的特定代码修改。本应用使用 `@google/genai` SDK 执行这些调用。

这种方法旨在通过并行化单个文件修改的执行，显著加快将 AI 建议的更改应用于代码库的过程。

## 功能特性

*   **项目上传：** 直接在浏览器中上传整个项目文件夹。
*   **交互式文件树：** 查看和导航项目的目录结构。
*   **文件内容查看器：**
    *   显示基于文本的文件内容。
    *   直接在编辑器面板中渲染常见的图像类型（PNG、JPEG、GIF、SVG）。
*   **一级 AI 提示助手：**
    *   协助为用户选择的一级 AI 生成结构化提示。
    *   自动包含项目的文件树和上传文件列表。
    *   提供一个模板，供用户添加其特定的修改需求。
*   **一级 AI 输出处理：**
    *   解析来自一级 AI 的结构化输出（包含线程数和每个文件的详细修改指令）。
*   **并发二级 AI 执行：**
    *   根据解析的指令和建议的线程数，使用 `@google/genai` SDK 对配置的 Gemini 模型进行并行 API 调用。
*   **内存中文件更新：** 将从二级 AI 收到的修改应用于浏览器内的文件表示。
*   **可配置设置（含优先级）：**
    *   **API 密钥：**
        1.  用户输入的密钥（在“设置”面板中）具有最高优先级。
        2.  如果用户字段为空，则使用部署者提供的密钥。对于 Vercel + Vite 构建，这意味着在 Vercel UI 中设置 `VITE_API_KEY`并通过 `import.meta.env.VITE_API_KEY` 访问。本地开发时，Vite 会从 `.env.local` 文件读取。
    *   **API URL：**
        1.  部署者提供的 URL（例如，对于 Vercel + Vite 构建的 `VITE_API_URL`）具有最高优先级。如果检测到并使用，则“设置”中的 API URL 输入字段将被隐藏。
        2.  如果没有检测到部署者 URL，用户可以在“设置”中输入自定义 URL。
        3.  如果以上两者均未设置，则默认为 `https://generativelanguage.googleapis.com`。
        4.  **注意：** `@google/genai` SDK 主要使用标准的 Google API 端点。自定义 API URL 可能对 SDK 发送请求的目标位置影响有限或无效。
    *   **Gemini 模型名称：** 指定用于二级 AI 修改的 Gemini 模型（默认为 `gemini-2.5-flash-preview-05-20`）。
    *   **忽略的文件夹：** 指定要从一级提示中排除、在树中折叠显示并在二级修改中跳过的文件夹。
*   **实时状态栏：** 提供有关当前操作、进度和错误的反馈。
*   **路径自动修正：** 如果一级 AI 输出的文件路径不包含根项目文件夹名称，则尝试修正它们。

## 工作流程

1.  **设置 API 配置（设置面板）：**
    *   **Gemini API 密钥：** 您可以在此处输入您的 API 密钥。如果您将此字段留空，应用程序将尝试使用部署者提供的 API 密钥（例如，如果在 Vercel 上使用 Vite 构建进行部署，则为 `VITE_API_KEY`；如果在本地使用 Vite 开发，则为您的 `.env.local` 文件中设置的密钥）。
    *   **Gemini API URL：**
        *   如果部署者已配置环境变量（例如 `VITE_API_URL`），则此字段可能被隐藏。
        *   否则，您可以输入自己的 API URL，或将其留空以使用默认值。
        *   **重要 SDK 说明：** 本应用使用 `@google/genai` SDK, 该 SDK 通常管理其自己的 API 端点。
    *   可选地，设置 **Gemini 模型名称**。
    *   可选地，自定义**忽略的文件夹**列表。
2.  **上传项目：** 点击“上传项目文件夹”按钮。
3.  **准备一级 AI 提示（一级面板 - 步骤 1）：**
    *   在“您的需求”文本区域中描述您的高级需求。
    *   点击“准备/刷新一级提示模板”按钮。
    *   查看并编辑生成的提示。
4.  **使用外部一级 AI（手动步骤）：**
    *   复制一级提示。
    *   将其粘贴到您选择的强大 LLM 中，并获取结构化响应。
5.  **处理一级 AI 输出（一级面板 - 步骤 2）：**
    *   粘贴 AI 的输出。
    *   点击“执行修改（调用二级 AI）”按钮。
6.  **并发执行和文件更新：** 应用会处理指令，并使用对 Gemini API 的并发 SDK 调用在内存中更新文件。
7.  **审查更改：** 在编辑器中查看更新后的文件。更改在内存中。

## 技术细节

*   **前端：** React (v19) 与 TypeScript，使用 Tailwind CSS 进行样式设计。
*   **AI 集成：**
    *   **一级（分析）：** 用户管理。
    *   **二级（修改）：** Google Gemini API，通过 `@google/genai` SDK。模型可配置（默认为 `gemini-2.5-flash-preview-05-20`）。
*   **环境变量（针对部署者）：**
    *   对于使用 Vite 构建的 Vercel 部署（推荐）：
        *   `VITE_API_KEY`: 部署者可以设置全局 API 密钥。应用程序通过 `import.meta.env.VITE_API_KEY` 读取。
        *   `VITE_API_URL`: 部署者可以设置全局 API URL。应用程序通过 `import.meta.env.VITE_API_URL` 读取。
*   **核心逻辑：** 内存中的文件系统表示、结构化文本解析、并发 API 调用。
*   **打包/服务：** 通过导入映射表（import map）的 ES 模块（用于基本本地服务）或 Vite（用于开发和 Vercel 构建）。

## 如何运行 (本地开发)

**选项 1: 简单 HTTP 服务器 (基础)**
1.  使用任何本地 HTTP 服务器提供文件服务 (例如, `npx serve .`)。
2.  通过 `http://localhost:PORT` 访问。API 密钥必须在设置中输入。

**选项 2: 使用 Vite (推荐用于增强开发体验)**
1.  安装 Node.js。
2.  运行 `npm install` (如果添加了包含 Vite 作为开发依赖项的 `package.json`) 或 `npm install -g vite`。
3.  在项目目录中运行 `vite`。
4.  **Vite 的本地环境变量:**
    *   项目根目录中提供了一个示例文件 `.env.local`。
    *   您可以将其复制为 `.env` 或直接使用。
    *   编辑此文件，添加您的 `VITE_API_KEY=your_local_api_key` 和 `VITE_API_URL=your_local_api_url` (可选)。
    *   应用程序 (`App.tsx`) 现在已配置为通过 `import.meta.env` 读取这些变量。
5.  **访问:** Vite 将提供一个本地 URL (例如, `http://localhost:5173`)。

## 部署

### Vercel (推荐使用 Vite 构建)

1.  **推送到 Git。**
2.  **导入到 Vercel。**
    *   **Framework Preset (框架预设):** 选择 "Vite" (或 "Other" 并配置构建命令)。
    *   **Build Command (构建命令):** 确保是 `vite build` 或 `npm run build` (如果您的 `package.json` 将 `vite build` 作为构建脚本)。您提供的 Vercel 构建日志确认正在使用 `vite build`。
    *   **Output Directory (输出目录):** Vercel 通常能正确检测到 Vite 的输出目录 (`dist`)。
3.  **在 Vercel 上配置环境变量:**
    *   在您的 Vercel 项目仪表板中，转到 "Settings" -> "Environment Variables"。
    *   **至关重要:** 使用 `VITE_` 前缀添加您的环境变量:
        *   `VITE_API_KEY`: 您的 Google Gemini API 密钥。
        *   `VITE_API_URL`: (可选) 您用于 Gemini 的自定义 API URL/代理。
    *   应用程序 (`App.tsx`) 现在已配置为从 `import.meta.env` 读取这些以 `VITE_` 为前缀的变量。这是 Vite 在 Vercel 上构建的正确方式。
4.  **部署。**

## 重要注意事项

*   **API 密钥安全：** 用户输入的密钥存储在浏览器状态中。部署者密钥 (`VITE_API_KEY` on Vercel) 如果配置正确，会在 Vite 构建过程中嵌入。对于本地开发，请确保您的 `.env` 或 `.env.local` 文件已添加到 `.gitignore`。
*   **一级 AI 输出格式：** 严格遵守指定的输出格式至关重要。
*   **内存操作：** 刷新页面将清除上传的文件和更改。

## 未来增强（潜在想法）

*   直接“保存到磁盘”或“下载项目”功能。
*   与 Git 集成以进行版本控制。
*   更复杂的 API 调用错误恢复和重试机制。
*   在应用更改前可视化差异的 UI。
*   用户可配置的二级提示模板。